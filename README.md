metalsmith-angular-templatecache
================================

This plugin concatenates and registers [AngularJS] templates in `$templateCache`. The HTML is wrapped in JavaScript and a new JavaScript file is generated. This is a version of [gulp-angular-templatecache] that has been adjusted to work natively for [Metalsmith]. Because of this, it takes the same options as the well-used gulp version.

[![npm version][npm-badge]][npm-link]
[![Build Status][travis-badge]][travis-link]
[![Dependencies][dependencies-badge]][dependencies-link]
[![Dev Dependencies][devdependencies-badge]][devdependencies-link]
[![codecov.io][codecov-badge]][codecov-link]

The JavaScript generated by this plugin, when beautified, looks similar to this.

    angular.module("templates").run([
        $templateCache,
        function ($templateCache) {
            $templateCache.put("template1.html", "... escaped HTML content ...");
            $tempalteCache.put("template2.html", "... escaped HTML content ...");
            // etc.
        }
    ]);

Including the generated JavaScript in your app and AngularJS will use the `$templateCache` when available.

*Note:* This plugin will **not** create a new AngularJS module by default and will use a module called `templates`. If you would like to create a new module, set `options.standalone` to `true`.


Installation
------------

Use [npm] to install this package easily.

    $ npm install --save metalsmith-angular-templatecache

Alternately you may edit your `package.json` and add this to your `dependencies` object:

    {
        ...
        "dependencies": {
            ...
            "metalsmith-angular-templatecache": "*"
            ...
        }
        ...
    }


Example
-------

Include this the same as any other Metalsmith plugin. Here's an example using the JSON format that also shows the default options. It is not necessary to specify any of these values unless you wish to change the defaults.

    {
        "plugins": {
            "metalsmith-angular-templatecache": {
                "bufferEncoding": "utf8",
                "destination": "templates.js",
                "destinationMode": "0644",
                "match": "**/*.html",
                "matchOptions": {},
                "module": "templates",
                "moduleSystem": "",
                "removeSource": true,
                "root": "",
                "standalone": false,
                "templateBody": "... see below ...",
                "templateFooter": "... see below ...",
                "templateHeader": "... see below ...",
                "transformUrl": null
            }
        }
    }

And this is how you would add the plugin using JavaScript. This example also includes a brief description of each option.

    // Load this just like any other plugin.
    var angularTemplatecache = require("metalsmith-angular-templatecache");

    // Then in your list of plugins you use it.  Here, we use default options.
    use(angularTemplatecache())

    // Alternately, you can specify options. The values shown here are the
    // defaults.
    use(angularTemplatecache({
        // When converting file buffers to strings and strings back into
        // buffers, what encoding should be used?
        bufferEncoding: "utf8",

        // Name of the generated file.
        destination: "templates.js",

        // File permissions of the generated JavaScript file.
        destinationMode: "0644",

        // Pattern of files to match.
        match: "**/*.html",

        // Options for matching files. See minimatch for more information.
        matchOptions: {},

        // Name of the module.
        module: "templates",

        // Wrap the cache in the given module system.  Supported systems:
        // "RequireJS", "Browserify", "ES6", and "IIFE" (Immediately-Invoked
        // Function Expression).
        moduleSystem: null,

        // When true, this option will remove the source files (**/*.html)
        // when they are compiled into the JavaScript.
        removeSource: true,

        // Prefix for template URLs; prepended to the filename.
        root: "",

        // Create a new AngularJS module instead of using an existing module.
        standalone: false,

        // Controls how the templates are generated. This is given its own
        // section in the documentation.
        templateBody: "... see below ...",
        templateFooter: "... see below ...",
        templateHeader: "... see below ...",

        // Transform the generated URL before it's put into $templateCache.
        // Sample:
        //   transformUrl: function (url) {
        //       return url.replace(/\.tpl\.html$/, '.html');
        //   }
        transformUrl: null
    })

This plugin uses [minimatch] to match files. The `.matchOptions` object can be filled with options that the [minimatch] library uses.

You will see that many options match up with [gulp-angular-templatecache] but not all of them align properly.

* `base` - Removed in favor of using [metalsmith-move-remove].
* `root` - This is always prepended verbatim instead of using the `path` module to resolve a filename.


Template Generation
-------------------

The `templateHeader`, `templateBody` and `templateFooter` options control how the JavaScript is generated to include the HTML templates in JavaScript.  They are written in Mustache, unlike [gulp-angular-templatecache].  Newlines have been added here to help with readability.

    templateHeader = "angular.module('{{{module}}}'{{#standalone}}, []{{/standalone}})
        .run(['$templateCache', function ($templateCache) {\n";
    templateBody = "$templateCache.put('{{{uri}}}','{{{contentEscaped}}}');\n";
    templateFooter = "}]);\n";

The JavaScript is assembled by building one header, one body section per included HTML file, then one footer.


API
---

<a name="module_metalsmith-angular-templatecache"></a>

## metalsmith-angular-templatecache
Metalsmith Angular $templateCache

Populates the `$templateCache` in Angular by converting the HTML templates
into a single JavaScript file.


* [metalsmith-angular-templatecache](#module_metalsmith-angular-templatecache)
    * [module.exports([options])](#exp_module_metalsmith-angular-templatecache--module.exports) ⇒ <code>function</code> ⏏
        * [~wrapInModuleSystem(moduleSystem, js)](#module_metalsmith-angular-templatecache--module.exports..wrapInModuleSystem) ⇒ <code>string</code>
        * [~processFileInfo(options, templateFile)](#module_metalsmith-angular-templatecache--module.exports..processFileInfo)
        * [~templateFile](#module_metalsmith-angular-templatecache--module.exports..templateFile) : <code>Object</code>
        * [~options](#module_metalsmith-angular-templatecache--module.exports..options) : <code>Object</code>

<a name="exp_module_metalsmith-angular-templatecache--module.exports"></a>

### module.exports([options]) ⇒ <code>function</code> ⏏
Factory to build middleware for Metalsmith.

**Kind**: Exported function
**Params**

- [options] <code>Object</code>

<a name="module_metalsmith-angular-templatecache--module.exports..wrapInModuleSystem"></a>

#### module.exports~wrapInModuleSystem(moduleSystem, js) ⇒ <code>string</code>
Wraps JavaScript in a given module system's loader.

**Kind**: inner method of [<code>module.exports</code>](#exp_module_metalsmith-angular-templatecache--module.exports)
**Params**

- moduleSystem <code>string</code>
- js <code>string</code>

<a name="module_metalsmith-angular-templatecache--module.exports..processFileInfo"></a>

#### module.exports~processFileInfo(options, templateFile)
Takes a file info object and adds a couple properties.

.content = Buffer from reading the file
.contentEscaped = File contents as an escaped string (not a Buffer)
.filename = File's name from Metalsmith
.uri = Generated from filename and options

**Kind**: inner method of [<code>module.exports</code>](#exp_module_metalsmith-angular-templatecache--module.exports)
**Params**

- options [<code>options</code>](#module_metalsmith-angular-templatecache--module.exports..options)
- templateFile [<code>templateFile</code>](#module_metalsmith-angular-templatecache--module.exports..templateFile)

<a name="module_metalsmith-angular-templatecache--module.exports..templateFile"></a>

#### module.exports~templateFile : <code>Object</code>
A template file, which is typically an HTML file that is to be converted
into JavaScript.

**Kind**: inner typedef of [<code>module.exports</code>](#exp_module_metalsmith-angular-templatecache--module.exports)
**Properties**

- content <code>Buffer</code>  
- contentEscaped <code>string</code> - `.content` converted to a string and escaped for JavaScript.  
- filename <code>string</code> - Filename from Metalsmith.  
- uri <code>string</code> - Generated from filename and options.  

<a name="module_metalsmith-angular-templatecache--module.exports..options"></a>

#### module.exports~options : <code>Object</code>
Options controlling the middleware factory.

**Kind**: inner typedef of [<code>module.exports</code>](#exp_module_metalsmith-angular-templatecache--module.exports)
**See**: [https://github.com/fidian/metalsmith-plugin-kit](https://github.com/fidian/metalsmith-plugin-kit)  
**Properties**

- bufferEncoding <code>string</code> - Used when converting file buffers into strings.  
- destination <code>string</code> - Destination file that will be generated from the HTML templates.  
- destinationMode <code>string</code> - File permissions for the generated file.  
- match <code>module:metalsmith-plugin-kit~matchList</code> - Files to match. Defaults to all `*.html` files.  
- matchOptions <code>module:metalsmith-plugin-kit~matchOptions</code> - Options controlling the matching behavior.  
- module <code>string</code> - Name of module that should have these templates.  
- moduleSystem <code>null</code> \| <code>string</code> - What module system to use. Can only be one of `browserify`, `es6`, `iife`, and `requirejs`. When falsy, this does not wrap in any module system.  
- removeSource <code>boolean</code> - When truthy, the template files are removed from the build.  
- root= <code>string</code> - Sets the root path to the templates. The path here is prepended to all of the paths of matched files.  
- standalone <code>boolean</code> - When true, declares the module as a standalone module with no dependencies. Otherwise the module must be declared in other JavaScript.  
- templateBody <code>string</code> - Controls how templates are added to the template cache. Mustache template.  
- templateFooter <code>string</code> - How the generated JavaScript finishes. Mustache template.  
- templateHeader <code>string</code> - How the generated JavaScript starts. Mustache template.  
- transformUrl <code>function</code> - A function that changes the filename into a URL. The default function does not change the filename at all.  



License
-------

This software is licensed under a [MIT license][LICENSE] that contains additional non-advertising and patent-related clauses.  [Read full license terms][LICENSE].


[AngularJS]: https://angular.io/
[codecov-badge]: https://img.shields.io/codecov/c/github/tests-always-included/angular-templatecache/master.svg
[codecov-link]: https://codecov.io/github/tests-always-included/angular-templatecache?branch=master
[dependencies-badge]: https://img.shields.io/david/tests-always-included/angular-templatecache.svg
[dependencies-link]: https://david-dm.org/tests-always-included/angular-templatecache
[devdependencies-badge]: https://img.shields.io/david/dev/tests-always-included/angular-templatecache.svg
[devdependencies-link]: https://david-dm.org/tests-always-included/angular-templatecache#info=devDependencies
[gulp-angular-templatecache]: https://github.com/miickel/gulp-angular-templatecache
[LICENSE]: LICENSE.md
[Metalsmith]: http://www.metalsmith.io/
[metalsmith-move-remove]: https://github.com/carlnordenfelt/metalsmith-move-remove
[minimatch]: https://github.com/isascs/minimatch
[npm]: https://npmjs.org/
[npm-badge]: https://img.shields.io/npm/v/angular-templatecache.svg
[npm-link]: https://npmjs.org/package/angular-templatecache
[travis-badge]: https://img.shields.io/travis/tests-always-included/angular-templatecache/master.svg
[travis-link]: http://travis-ci.org/tests-always-included/angular-templatecache
